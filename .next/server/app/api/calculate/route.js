"use strict";(()=>{var e={};e.id=736,e.ids=[736],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},824:(e,t,a)=>{a.r(t),a.d(t,{originalPathname:()=>A,patchFetch:()=>m,requestAsyncStorage:()=>p,routeModule:()=>u,serverHooks:()=>f,staticGenerationAsyncStorage:()=>d});var r={};a.r(r),a.d(r,{POST:()=>l});var o=a(9303),n=a(8716),i=a(670),s=a(7070),c=a(2914);async function l(e){try{let{filters:t={},parts:a=[]}=await e.json();if(!a||0===a.length)return s.NextResponse.json({success:!1,message:"Debe seleccionar al menos una parte"},{status:400});let r=await (0,c.Nf)(t,a);return s.NextResponse.json({success:!0,count:r.results.length,results:r.results,totals:r.totals})}catch(e){return console.error("Error en el c\xe1lculo:",e),s.NextResponse.json({success:!1,message:`Error al calcular materiales: ${e instanceof Error?e.message:"Error desconocido"}`},{status:500})}}let u=new o.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/calculate/route",pathname:"/api/calculate",filename:"route",bundlePath:"app/api/calculate/route"},resolvedPagePath:"D:\\Transelca - Martin Pinedo\\Proyecto-Desglose-de-Torres\\app\\api\\calculate\\route.ts",nextConfigOutput:"",userland:r}),{requestAsyncStorage:p,staticGenerationAsyncStorage:d,serverHooks:f}=u,A="/api/calculate/route";function m(){return(0,i.patchFetch)({serverHooks:f,staticGenerationAsyncStorage:d})}},2914:(e,t,a)=>{a.d(t,{Nf:()=>d,FW:()=>u,tW:()=>p});let r=require("mongodb"),o=null,n=null;async function i(){if(!n){if(!process.env.MONGODB_URI)throw Error("MONGODB_URI must be set");o=new r.MongoClient(process.env.MONGODB_URI),await o.connect(),n=o.db("torres")}return n}function s(){return i().then(e=>e.collection("piezas"))}let c=new Set(["BGDA","BSUP","BMED","BINF","BDER","BIZQ","BSUP/MED"]),l=new Set(["PATA 0","PATA 0.0","PATA 1.5","PATA 3","PATA 3.0","PATA 4.5","PATA 6","PATA 6.0","PATA 7.5","PATA 9","PATA 9.0"]);async function u(e){let t=await s(),a={},r={TIPO:"tipo",FABRICANTE:"fabricante",CABEZA:"cabeza",CUERPO:"cuerpo",PARTE_DIVISION:"parte_division",TRAMO:"tramo"};for(let[o,n]of Object.entries(r)){let i={};for(let[t,a]of Object.entries(e))if(a&&t!==o){let e=r[t];e&&(i[e]=a)}let s=await t.distinct(n,{...i,[n]:{$ne:null,$ne:""}});a[o]=s.filter(e=>e&&"string"==typeof e).map(e=>e.trim()).sort()}return a}async function p(e){let t=await s(),a={};for(let[t,r]of Object.entries({tipo:"tipo",fabricante:"fabricante",cabeza:"cabeza",parte:"parte_division",cuerpo:"cuerpo",tramo:"tramo"}))e[t]&&("tramo"===t?a[r]=RegExp(`^${e[t]}$`,"i"):a[r]=e[t]);return await t.find(a).limit(500).toArray()}async function d(e,t){let a=await s(),r={};e.tipo&&(r.tipo=e.tipo),e.fabricante&&(r.fabricante=e.fabricante),e.cabeza&&(r.cabeza=e.cabeza);let o=await a.find(r).toArray(),n=[];for(let e of o){let a=(e.parte_division||"").trim().toUpperCase();if(!a)continue;let r=Number(e.cantidad_x_torre)||0,o=0;for(let e of t){let t=(e.part||"").trim().toUpperCase(),n=e.quantity||0;if(a===t){let e=c.has(a)||l.has(a);e&&1===r?o+=r*n:c.has(a)?o+=r*n/2:l.has(a)?o+=Math.ceil(r*n/4):e||(o+=r*n)}}if(o>0){let t=o*(Number(e.peso_unitario)||0);n.push({...e,cantidad_original:r,cantidad_calculada:o,peso_total:t})}}let i=n.reduce((e,t)=>e+t.cantidad_calculada,0),u=n.reduce((e,t)=>e+t.peso_total,0);return{results:n,totals:{total_pieces:i,total_weight:u}}}}};var t=require("../../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),r=t.X(0,[276,972],()=>a(824));module.exports=r})();